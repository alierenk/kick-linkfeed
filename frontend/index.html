<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>LinkFeed</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<header>
  <div class="header-content">
    <div class="left">LinkFeed</div>
    <div class="center">
        <img src="kick-logo.png" alt="Kick Logo" class="kick-logo">
        <input type="text" id="channelinput" placeholder="Kanal adÄ± girin">
    </div>
    <div class="right">
      <div class="viewers">10 gizli izleyici</div>
      <button>Logout</button>
    </div>
  </div>
</header>

<div id="loading" class="hidden">
  <div class="spinner"></div>
</div>

<div id="links"></div>

<script>
const container = document.getElementById("links");
const loading = document.getElementById("loading");
const channelInput = document.getElementById("channelinput");
let currentChannel = null;
const wsPython = new WebSocket("ws://localhost:6789");

function clearLinks() {
    container.innerHTML = "";
}

async function fetchMessages(channel) {
    if (!channel) return;
    loading.classList.remove("hidden");
    try {
        const res = await fetch(`/messages?channel=${channel}`);
        const messages = await res.json();
        clearLinks();
        messages.forEach(data => {
            if (!data.links || data.links.length === 0) return;

            const div = document.createElement("div");
            div.className = "link-box";

            const leftDiv = document.createElement("div");
            leftDiv.className = "username-link";

            if (data.avatar) {
                const img = document.createElement("img");
                img.src = data.avatar;
                img.alt = data.username;
                leftDiv.appendChild(img);
            }

            const usernameSpan = document.createElement("span");
            usernameSpan.textContent = data.username + " :";
            leftDiv.appendChild(usernameSpan);

            data.links.forEach(url => {
                const a = document.createElement("a");
                a.href = url;
                a.target = "_blank";
                a.rel = "noopener noreferrer";
                a.textContent = url;
                leftDiv.appendChild(a);
            });

            div.appendChild(leftDiv);

            const time = document.createElement("span");
            time.className = "timestamp";
            const date = new Date(data.timestamp);
            time.textContent = date.toLocaleString();
            div.appendChild(time);

            container.prepend(div);
        });
    } catch (err) {
        console.error(err);
        clearLinks();
    } finally {
        loading.classList.add("hidden");
    }
}

channelInput.addEventListener("change", () => {
    const channelName = channelInput.value.trim();
    if (!channelName) return;
    currentChannel = channelName;
    localStorage.setItem("lastChannel", channelName);
    fetchMessages(channelName);
    if (wsPython.readyState === WebSocket.OPEN) {
        wsPython.send(JSON.stringify({ type: "change_channel", channel: channelName }));
    }
});

window.addEventListener("DOMContentLoaded", () => {
    const lastChannel = localStorage.getItem("lastChannel");
    if (lastChannel) {
        channelInput.value = lastChannel;
        currentChannel = lastChannel;
        fetchMessages(lastChannel);
        if (wsPython.readyState === WebSocket.OPEN) {
            wsPython.send(JSON.stringify({ type: "change_channel", channel: lastChannel }));
        } else {
            wsPython.addEventListener("open", () => {
                wsPython.send(JSON.stringify({ type: "change_channel", channel: lastChannel }));
            });
        }
    }
});

wsPython.onmessage = (event) => {
    const data = JSON.parse(event.data);
    if (!data.links || data.links.length === 0) return;

    const div = document.createElement("div");
    div.className = "link-box";

    const leftDiv = document.createElement("div");
    leftDiv.className = "username-link";

    if (data.avatar) {
        const img = document.createElement("img");
        img.src = data.avatar;
        img.alt = data.username;
        leftDiv.appendChild(img);
    }

    const usernameSpan = document.createElement("span");
    usernameSpan.textContent = data.username + " :";
    leftDiv.appendChild(usernameSpan);

    data.links.forEach(url => {
        const a = document.createElement("a");
        a.href = url;
        a.target = "_blank";
        a.rel = "noopener noreferrer";
        a.textContent = url;
        leftDiv.appendChild(a);
    });

    div.appendChild(leftDiv);

    const time = document.createElement("span");
    time.className = "timestamp";
    const date = new Date(data.timestamp || Date.now());
    time.textContent = date.toLocaleString();
    div.appendChild(time);

    container.prepend(div);
    loading.classList.add("hidden");
};
</script>
</body>
</html>
